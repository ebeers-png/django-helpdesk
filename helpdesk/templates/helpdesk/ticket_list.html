{% extends "helpdesk/base.html" %}

{% load i18n humanize static in_list %}
{% load natural_time_date %}

{% block helpdesk_title %}{% trans "Tickets" %}{% endblock %}

{% block helpdesk_head %}
<!-- Timeline 3 CSS -->
{% if helpdesk_settings.HELPDESK_USE_CDN %}
<link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">
{% else %}
<link title="timeline-styles" rel="stylesheet" href="{% static 'helpdesk/vendor/timeline3/css/timeline.css' %}">
{% endif %}
{% endblock %}

{% block h1_title %}Tickets
{% if from_saved_query %} [{{ saved_query.title }}]{% endif %}
{% endblock %}


{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
</li>
{% if from_saved_query and saved_query.user == user %}
<li class="breadcrumb-item">{% trans "Saved Query" %}</li>
<li class="breadcrumb-item active">{{ saved_query.title }}</li>
{% else %}
<li class="breadcrumb-item active">{% trans "Overview" %}</li>
{% endif %}
{% endblock %}


{% block helpdesk_body %}
<div class="ticket_list_page">
    <!-- Action Toolbar -->
    <div class="d-flex flex-wrap justify-content-between overflow-auto pb-2 mw-100" style="max-width: 100%;">
        <a id="show_query" class="btn btn-outline-primary mr-2" onclick="toggleQuerySelector()">
            <span id="show_query_text"><i class="fas fa-eye"></i> Show Filter Menu</span>
            <span id="hide_query_text"><i class="fas fa-eye-slash"></i> Hide Filter Menu</span>
        </a>
        <div class="d-flex align-items-center">
            <div class="input-group">
                <div class="input-group-prepend">
                    <label class="input-group-text bg-white border-0">Select:</label>
                </div>
                <div class="input-group-append">
                    <button id="select_all_btn" class="btn btn-outline-primary rounded-left font-weight-semibold" type="button">All <i class="fa fa-plus-circle mr-1"></i></button>
                    <button id="select_none_btn" class="btn btn-outline-danger font-weight-semibold" type="button">None <i class="fa fa-times-circle mr-1"></i></button>
                </div>
            </div>
        </div>
        <div class="mr-auto d-flex align-items-center ml-2">{{ ticket_index_start }}-{{ ticket_index_end }} of {{ ticket_total }}<em><span class="select_count"></span></em></div>
        {% if tag_choices|length %}
        <div>
            <div class="dropdown">
                <a id="editTagsDropdown" class="btn btn-outline-secondary dropdown-toggle disabled" href="#" role="button" data-toggle="dropdown" data-boundary="window" aria-expanded="false" onclick="getTags()">Add/Remove Tags</a>
                <div class="dropdown-menu dropdown-menu-left"  onclick="event.stopPropagation()" style="z-index: 1021;">
                    <form id="tagForm" class="pr-3 pt-1">
                        {% csrf_token %}
                        {% for tag in tag_choices %}
                        <div class="form-check">
                             <div class="custom-control custom-checkbox">
                                 <input type="checkbox" class="custom-control-input" id="tagCheck{{ tag.id }}" value="{{ tag.id }}" name="tagCheck">
                                 <label class="custom-control-label" for="tagCheck{{ tag.id }}"><span class="badge badge-{{tag.color}}">{{ tag.name }}</span></label>
                            </div>
                        </div>
                        {% endfor %}
                    </form>
                    <button onclick="massUpdateTags()" class="btn btn-primary m-2 float-right">Save</button>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="d-flex align-items-center mr-2">
            <form method='post' action="{% url 'helpdesk:mass_update' %}" id="ticket_mass_update">
                {% csrf_token %}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <label class="input-group-text bg-white border-0">Action:</label>
                    </div>
                    <select class="custom-select rounded-left" name="action" id="id_mass_action" disabled>
                        <option selected>Choose...</option>
                        <option value="take">Take (Assign to me)</option>
                        <option value="delete">Delete</option><option value="merge">Merge</option>
                        <option value="export">Export</option><option value="pair">Pair to BEAM inventory</option>
                        <optgroup label="Close">
                            <option value="close">Close (Don't Send E-Mail)</option>
                            <option value="close_public">Close (Send E-Mail)</option>
                        </optgroup>
                        <optgroup label="Set Owner">
                            <option value="unassign">Nobody (Unassign)</option>
                            {% for u in user_choices %}
                            <option value="assign_{{ u.id }}">{% if u.first_name and u.last_name %}{{ u.first_name}} {{ u.last_name }}{% else %}{{ u.username }}{% endif %}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                    <div class="input-group-append">
                        <button id="massActionButton" type="button" onclick="massUpdate()" class="btn btn-outline-secondary" disabled>Run Action <i class="fa fa-arrow-circle-right mr-1"></i></button>
                    </div>
                </div>
                <!-- Pass vars to View for exporting to work Properly -->
                <input type='hidden' name='visible' value=''/>
                <input type='hidden' name='selected_ids' value=''/>
                <input type="hidden" name="queue_length" value="{{ query_params.filtering.queue__id__in|length }}"/>
            </form>
        </div>
        <div>
            <div id="colvis" class="dropdown">
                <button class="btn btn-outline-secondary float-right font-weight-semibold dropdown-toggle" type="button" data-boundary="window" aria-expanded="false">Column Visibility</button>
                <div class="dropdown-menu dropdown-menu-left text-center p-2" style="min-width: 0; z-index: 1021;">
                    <div class="btn-group-vertical btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'priority')"> Priority
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'queue')"> Queue
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'form')"> Form
                        </label>
                        <label class="btn btn-outline-secondary active">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'status')" checked> Status
                        </label>
                        <label class="btn btn-outline-secondary active">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'assigned_to')" checked> Owner
                        </label>
                        <label class="btn btn-outline-secondary active">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'submitter')" checked> Submitter
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'paired_count')"> Paired Count
                        </label>
                        <label class="btn btn-outline-secondary active">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'created')" checked> Created
                        </label>
                        <label class="btn btn-outline-secondary active">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'last_reply')" checked> Last Reply
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'due_date')"> Due Date
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'time_spent')"> Time Spent
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'kbitem')"> KB Item
                        </label>
                        <label class="btn btn-outline-secondary">
                            <input type="checkbox" onchange="toggleColumn(this.checked, 'tags')"> Tags
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- / Action Toolbar -->
    <div class="row">
    <div class="col-sm-8 col-md-9 col-lg-10 order-1 pl-3">
        <div id="query_card" class="card mb-2">
            <div class="card-body p-0">
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active overflow-hidden" id="datatabletabcontents" role="tabpanel"
                    aria-labelledby="datatabletabcontents-tab">
                        <!-- Data Table -->
                        <div class="table-responsive"> <!-- style="max-height: 81.5vh;">-->
                            <table class="table table-bordered table-sm table-striped m-0" id="dataTable" width="100%" cellspacing="0">
                                <thead class="thead-light">
                                    <tr id="headers"> <!-- Headers -->
                                        <th class="filter-top" data-colname="ticket" colspan="2">{% trans "Ticket" %}</th>
                                        <th class="filter-top d-none" data-colname="priority">{% trans "Priority" %}</th>
                                        <th class="filter-top d-none" data-colname="queue">{% trans "Queue" %}</th>
                                        <th class="filter-top d-none" data-colname="form">{% trans "Form" %}</th>
                                        <th class="filter-top" data-colname="status">{% trans "Status" %}</th>
                                        <th class="filter-top" data-colname="assigned_to">{% trans "Owner" %}</th>
                                        <th class="filter-top" data-colname="submitter">{% trans "Submitter" %}</th>
                                        <th class="filter-top d-none" data-colname="paired_count">{% trans "Paired Count" %}</th>
                                        <th class="filter-top" data-colname="created">{% trans "Created" %}</th>
                                        <th class="filter-top" data-colname="last_reply">{% trans "Last Reply" %}</th>
                                        <th class="filter-top d-none" data-colname="due_date">{% trans "Due Date" %}</th>
                                        <th class="filter-top d-none" data-colname="time_spent">{% trans "Time Spent" %}</th>
                                        <th class="filter-top d-none" data-colname="kbitem">{% trans "KB item" %}</th>
                                        <th class="filter-top d-none" data-colname="tags">{% trans "Tags" %}</th>
                                        {% if query_params.filtering.queue__id__in|length == 1 %}
                                        {% for col_name, display_name in extra_data_columns.items %}
                                        <th class="filter-top" data-colname="{{ col_name }}">{{ display_name }}</th>
                                        {% endfor %}
                                        {% endif %}
                                    </tr>
                                    <!--
                                    <tr>  Filters
                                        {# <th></th> #}
                                        <th colspan="2"><input type="text" class="form-control text-body" placeholder="Filter" data-colfilter="ticket" value="{{query_params.filtering.title__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"><input type="text" class="form-control" placeholder="Filter" data-colfilter="queue" value="{{query_params.filtering.queue__title__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th class="d-none"><input type="text" class="form-control" placeholder="Filter" data-colfilter="form" value="{{query_params.filtering.ticket_form__name__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th></th>
                                        <th><input type="text" class="form-control" placeholder="Filter" data-colfilter="assigned_to" value="{{query_params.filtering.assigned_to__email__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th><input type="text" class="form-control" placeholder="Filter" data-colfilter="submitter" value="{{query_params.filtering.submitter_email__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th class="d-none"><input type="text" class="form-control" placeholder="Filter" data-colfilter="paired_count" value="{{query_params.filtering.paired_count__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        <th></th>
                                        <th></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"><input type="text" class="form-control" placeholder="Filter" data-colfilter="kbitem" value="{{query_params.filtering.kbitem__title__icontains}}" spellcheck="false" data-ms-editor="true"></th>
                                        {% comment %} TODO: add support for extra data columns {% endcomment %}
                                    </tr>
                                    -->
                                </thead>
                                <tbody>
                                    {% for ticket in ticket_list %}
                                    <tr> <!-- Data -->
                                        <td class="text-center"><input type="checkbox" name="ticket_id" value="{{ ticket.id }}" class="ticket_multi_select"></td>
                                        <td class="tickettitle" data-toggle="tooltip" title="Edit {{ ticket.title }}"><a href="{{ ticket.get_absolute_url }}">{{ ticket.id }}. {{ ticket.title }}</a></td>
                                        <td class="d-none text-center">
                                            <span class="badge badge-{{ ticket.get_priority_css_class }}">{{ ticket.get_priority }}</span>
                                        </td>
                                        <td class="d-none">{{ ticket.queue }}</td>
                                        <td class="d-none">{{ ticket.ticket_form.name }}</td>
                                        <td class="text-center">
                                            <span class="badge badge-{{ ticket.get_status_css_class }}">{{ ticket.get_status_display }}</span>
                                        </td>
                                        <td>{% if ticket.get_assigned_to != "Unassigned" %}{{ ticket.get_assigned_to }}{% endif %}</td> {# Remove if statement for "Unassigned" instead of blank #}
                                        <td>{{ ticket.submitter_email }}</td>
                                        <td class="d-none">{{ ticket.paired_count }}</td>
                                        <td>{{ ticket.created|naturaltimedate|default_if_none:'' }}</td>
                                        <td>{{ ticket.last_reply|naturaltimedate|default_if_none:'' }}</td>
                                        <td class="d-none">{{ ticket.due_date|naturaltimedate|default_if_none:'' }}</td>
                                        <td class="d-none">{{ ticket.time_spent_formatted }}</td>
                                        <td class="d-none">{{ ticket.kbitem.title}}</td>
                                        <td class="d-none">
                                            {% for tag in ticket.tags.all %}
                                            <span class="badge badge-{{ tag.color }}">{{ tag.name }}</span>
                                            {% endfor %}
                                        </td>
                                        {% comment %} TODO: add support for extra data columns {% endcomment %}
                                    </tr>

                                    {% empty %}
                                    <tr><td colspan='100'>{% trans "No tickets found." %}</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- / Data Table -->
                        <!-- Pagination Toolbar -->
                            <div class="d-flex flex-wrap border-top px-2 py-2" style="//background-color: #f7f7f7">
                                {% with 't_page' as page_var %}
                                <div class="d-flex align-items-center">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <label class="input-group-text font-weight-normal">Show</label>
                                        </div>
                                        <div class="btn-group dropup">
                                            <button class="btn btn-outline-secondary rounded-0 font-weight-semibold dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">{{ tickets_per_page }}</button>
                                            <div class="dropdown-menu p-1 text-right" style="min-width: 0">
                                                <button class="dropdown-item px-3 rounded-lg {% if tickets_per_page == 10 %}active{% endif %}" onclick="updateTicketsPerPage(10)">10</button>
                                                <button class="dropdown-item px-3 rounded-lg {% if tickets_per_page == 25 %}active{% endif %}" onclick="updateTicketsPerPage(25)">25</button>
                                                <button class="dropdown-item px-3 rounded-lg {% if tickets_per_page == 50 %}active{% endif %}" onclick="updateTicketsPerPage(50)">50</button>
                                                <button class="dropdown-item px-3 rounded-lg {% if tickets_per_page == 100 %}active{% endif %}" onclick="updateTicketsPerPage(100)">100</button>
                                            </div>
                                        </div>
                                        <div class="input-group-append border-left border-secondary">
                                            <label class="input-group-text font-weight-normal" for="inputGroupSelect01">Tickets</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mr-auto d-flex align-items-center ml-2">{{ ticket_index_start }}-{{ ticket_index_end }} of {{ ticket_total }}<em><span class="select_count"></span></em></div>
                                <div class="flex-fill justify-content-end">
                                    <div class="btn-toolbar float-right" role="toolbar" style="bottom: 0;">
                                        <div class="btn-group mr-2" role="group">
                                            {% if ticket_list.has_previous %}
                                            <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery()">First</button>
                                            <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ ticket_list.previous_page_number }})">Previous</button>
                                            {% else %}
                                            <button class="btn btn-primary font-weight-bold disabled">First</button>
                                            <button class="btn btn-primary font-weight-bold disabled">Previous</button>
                                            {% endif %}
                                        </div>
                                        <div class="btn-group mr-2" role="group">
                                            {% with 3 as thresh %}
                                            {% for i in ticket_list.paginator.page_range %}
                                            {% if ticket_list.number == i %}
                                            <button class="btn btn-outline-primary active font-weight-bold">{{ i }}</button>
                                            {% elif i <= ticket_list.number|add:5 and i >= ticket_list.number|add:-5 %}
                                            <button class="btn btn-outline-primary font-weight-bold" onclick="paginatedQuery({{ i }})">{{ i }}</button>
                                            {% endif %}
                                            {% endfor %}
                                            {% endwith %}
                                        </div>
                                        <div class="btn-group" role="group">
                                            {% if ticket_list.has_next %}
                                            <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ ticket_list.next_page_number }})">Next</button>
                                            <button class="btn btn-primary font-weight-bold" onclick="paginatedQuery({{ ticket_list.paginator.num_pages }})">Last</button>
                                            {% else %}
                                            <button class="btn btn-primary font-weight-bold disabled">Next</button>
                                            <button class="btn btn-primary font-weight-bold disabled">Last</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}
                            </div>
                        <!-- / Pagination Toolbar -->
                </div>
                <div class="tab-pane fade" id="timelinetabcontents" role="tabpanel" aria-labelledby="timelinetabcontents-tab">
                    <div id='timeline-embed' style="width: 100%; height: 80vh"></div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="col-sm-4 col-md-3 col-lg-2 pr-0" id="query_select">
        <div class="card mb-3">
            <div class="card-header font-weight-bold bg-gray">
                Your Saved Searches
            </div>
            <div class="card-body p-0">

                <ul id="saved_list" class="list-group">
                    {% for q in user_saved_queries %}
                    {% if saved_query.id != q.id %}
                    <li class="saved_query_selector list-group-item list-group-item-light list-group-item-action text-primary p-2 pl-3 pr-3 border-bottom border-left-0 border-right-0 border-top-0 rounded-0" type="button" value="{{ q.id }}">
                        {{ q.title }}<button class="delete_query btn btn-danger" style="float:right; z-index=50;padding:0 .4rem;" value="{{ q.id }}" title="Delete Saved Search"><i class="fas fa-times"></i></button>
                    </li>
                    {% else %}
                    <li class="saved_query_selector saved_query_active list-group-item list-group-item-secondary list-group-item-action p-2 pl-3 pr-3 border-bottom border-left-0 border-right-0 border-top-0 rounded-0" type="button" value="{{ q.id }}">
                        {{ q.title }}<button class="delete_query btn btn-danger" style="float:right; z-index=50;padding:0 .4rem;" value="{{ q.id }}" title="Delete Saved Search"><i class="fas fa-times"></i></button>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>

                <div class="border-bottom bg-light p-3">
                    <form method='post' action='{% url 'helpdesk:savequery' %}'>
                        {% csrf_token %}
                        <input type='hidden' name='query_encoded' value='{{ urlsafe_query }}'/>
                        <input type='hidden' name='visible' value=''/>
                        Save the current search filters?
                        <div class="input-group pt-1">
                          <input type="text" class="form-control" name='title' id='id_title' placeholder="Name" aria-label="Save query name" aria-describedby="basic-addon2">
                          <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="submit">Save</button>
                          </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="card mb-3" >
            <div class="card-header font-weight-bold bg-gray">
                {% trans "Search Filters" %}
            </div>
            <div class="card-body p-0">
                <form method="get" id="query_form" action="{% url 'helpdesk:list' %}">
                    <div class="border-bottom p-3">
                        {% include 'helpdesk/filters/sorting.html' %}
                    </div>

                    <div class="card-body overflow-auto p-1"> <!-- style="max-height: 67.75vh;">-->
                        <ul class="list-group list-group-flush">
                            <li id="filterBoxOwner" class="list-group-item {% if query_params.filtering.assigned_to__id__in %} filterBoxShow{% endif %} mb-2">
                                {% include 'helpdesk/filters/owner.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.queue__id__in %} filterBoxShow{% endif %} mb-2"  id="filterBoxQueue">
                                {% include 'helpdesk/filters/queue.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.ticket_form__id__in %} filterBoxShow{% endif %} mb-2"  id="filterBoxTicketForm">
                                {% include 'helpdesk/filters/ticket_form.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.status__in %} filterBoxShow{% endif %} mb-2" id="filterBoxStatus">
                                {% include 'helpdesk/filters/status.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.priority__in %} filterBoxShow{% endif %} mb-2" id="filterBoxPriority">
                                {% include 'helpdesk/filters/priority.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.created__date__gte or query_params.filtering.created__date__lte %} filterBoxShow{% endif %} mb-2" id='filterBoxDates'>
                                {% include 'helpdesk/filters/date.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.search_string %} filterBoxShow{% endif %} mb-2" id="filterBoxKeywords">
                                {% include 'helpdesk/filters/keywords.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.kbitem__in %} filterBoxShow{% endif %} mb-2" id="filterBoxKBItems">
                                {% include 'helpdesk/filters/kbitems.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.paired_count__lte or query_params.filtering.paired_count__gte %} filterBoxShow{% endif %} mb-2" id="filterBoxPairedCount">
                                {% include 'helpdesk/filters/paired_count.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.last_reply__date__lte or query_params.filtering.last_reply__date__gte %} filterBoxShow{% endif %}" id="filterBoxLastReply">
                                {% include 'helpdesk/filters/last_reply.html' %}
                            </li>
                            <li class=" list-group-item {% if query_params.filtering.tags__in %} filterBoxShow{% endif %}" id="filterBoxTags">
                                {% include 'helpdesk/filters/tags.html' %}
                            </li>
                        </ul>
                    </div>

                    <!-- Hidden Fields -->
                    <input type='hidden' id='n' name='n' value="{{ tickets_per_page }}"/>
                    <input type='hidden' id='p' name='p' value="1"/>
                    <input type='hidden' id='saved-query' name='saved-query' value="{{ saved_query.id }}"/>
                    {% comment %} TODO: Make column filter hidden fields dynamically generate from columns {% endcomment %}
                    <!--
                    <input type='hidden' id='ticket_filter' name='ticket_filter'>
                    <input type='hidden' id='priority_filter' name='priority_filter'>
                    <input type='hidden' id='queue_filter' name='queue_filter'>
                    <input type='hidden' id='form_filter' name='form_filter'>
                    <input type='hidden' id='status_filter' name='status_filter'>
                    <input type='hidden' id='assigned_to_filter' name='assigned_to_filter'>
                    <input type='hidden' id='submitter_filter' name='submitter_filter'>
                    <input type='hidden' id='paired_count_filter' name='paired_count_filter'>
                    <input type='hidden' id='created_filter' name='created_filter'>
                    <input type='hidden' id='last_reply_filter' name='last_reply_filter'>
                    <input type='hidden' id='due_date_filter' name='due_date_filter'>
                    <input type='hidden' id='time_spent_filter' name='time_spent_filter'>
                    <input type='hidden' id='kbitem_filter' name='kbitem_filter'>
                    -->
                </form>

                <div class="border-bottom border-top bg-light p-2">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-primary w-40 m-1" type='button' onclick='paginatedQuery(1, true)'>{% trans "Apply Filters" %}</button>
                        <a class="btn btn-danger w-40 m-1" type='button' href="{% url 'helpdesk:list' %}?sort=created">{% trans "Clear Filters" %}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}

{% block helpdesk_js %}
<script src='{% static "helpdesk/filter.js" %}'></script>
<!-- Timeline 3 JavaScript -->
{% if helpdesk_settings.HELPDESK_USE_CDN %}
<script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
{% else %}
<script src="{% static 'helpdesk/vendor/timeline3/js/timeline.js' %}"></script>
{% endif %}

<style>
    #dataTable td {
        vertical-align: middle
    }

    {# Prevents rows scrolling above frozen header #}
    #dataTable th.filter-top {
        top: -1px;
    }
</style>

<script>
    $(document).ready(function () {
        // Restore column visibility based on user's session preferences
        // Note: can use localStorage instead to persist between sessions
        if (sessionStorage['visible_cols']) {
            vis = sessionStorage['visible_cols'].split(',')
            for (const col of document.querySelectorAll('#headers th')) {
                num = colNums[col.dataset.colname]
                if (vis.includes(col.dataset.colname)) {
                    toggleColumn(true, col.dataset.colname, false)
                    $('#colvis .btn-group-toggle label:nth-child(' + (num-1) + ')').addClass('active')
                    $('#colvis .btn-group-toggle label:nth-child(' + (num-1) + ') input').prop('checked', true)
                } else {
                    toggleColumn(false, col.dataset.colname, false)
                    $('#colvis .btn-group-toggle :nth-child(' + (num-1) + ')').removeClass('active')
                    $('#colvis .btn-group-toggle label:nth-child(' + (num-1) + ') input').prop('checked', false)
                }
            }
        } else {
            // No preference found for session, use defaults
            sessionStorage['visible_cols'] = get_visible_cols()
        }

        // DISABLED
        // Scroll the query results to fill the viewport by default
        // Browser will take over scroll position on reload
        // scrollQueryCard()

        // Column visibility dropdown will no longer close when a column is changed
        $('#colvis button').on('click', function (event) {
            $('#colvis button').dropdown('toggle')
        });

        $('body').on('click', function (e) {
            if (!$('#colvis').is(e.target)
            && $('#colvis').has(e.target).length === 0
            && $('.open').has(e.target).length === 0
            ) {
                $('#colvis button').dropdown('hide')
            }
        });

        $('[data-colfilter]').on('keyup', function(e) {
            if (e.keyCode == 13) {
                paginatedQuery()
            }
        })
    })

    colNums = {"id": 0};
    idx = 1;
    for (const col of document.querySelectorAll('#headers th')) {
        colNums[col.dataset.colname] = idx++;
    }

    // Toggle visibility for given column
    function toggleColumn(show, col, save=true) {
        colNum = colNums[col]

        if (show) {
            $('#dataTable th:nth-child(' + colNum + ')').removeClass("d-none")
            $('#dataTable td:nth-child(' + (colNum+1) + ')').removeClass("d-none")
        } else {
            $('#dataTable th:nth-child(' + colNum + ')').addClass("d-none")
            $('#dataTable td:nth-child(' + (colNum+1) + ')').addClass("d-none")
        }

        if (save) { sessionStorage['visible_cols'] = get_visible_cols() }
    }

    // Toggle visibility for query selection card
    function toggleQuerySelector() {
        let queryToggle = !(localStorage.getItem("helpdesk.show_query") === 'true');

        $('#show_query_text').toggle(!queryToggle);
        $('#hide_query_text').toggle(queryToggle);
        $("#query_select").toggle(queryToggle);
        let resultsCol = $("#query_card").parent();
        resultsCol.toggleClass('col-12', !queryToggle);
        resultsCol.toggleClass('col-sm-8', queryToggle);
        resultsCol.toggleClass('col-md-9', queryToggle);
        resultsCol.toggleClass('col-lg-10', queryToggle);

        localStorage.setItem("helpdesk.show_query", queryToggle);
    }

    // Detect which columns are currently visible
    // Column visibility determines what data is exported
    function get_visible_cols() {
        var visible_columns = [];
        for (const col of document.querySelectorAll('#headers th')) {
            if (!col.classList.contains("d-none")) {
                visible_columns.push(col.dataset.colname);
            }
        }
        // Add data to post field to be avaiable in mass_update function, and save_query
        $('input[name="visible"]').each(function () {
            $(this).val(visible_columns.toString());
        });
        return visible_columns
    }

    function updateTicketsPerPage(tickets_per_page) {
        document.getElementById('n').value = tickets_per_page
        paginatedQuery()
    }

    var from_saved_query = {% if from_saved_query %}true{% else %}false{% endif %};
    function paginatedQuery(page=1, clearSavedQuery=false) {
        document.getElementById('p').value = page
        /*
        for (const colfilter of document.querySelectorAll('[data-colfilter]')) {
            document.getElementById(colfilter.dataset['colfilter'] + '_filter').value = colfilter.value
        }
        */

        if (!clearSavedQuery && $("#saved-query").val() !== '') {
            // keep the saved query input and erase everything else
            $("#query_form").find(':input:not(#saved-query)').not(":input[type=hidden]").filter(function() {
                return true;
            }).attr('disabled', 'disabled');
            document.forms['query_form'].submit();
        } else {
            if (clearSavedQuery) {
                // remove the saved query before submitting the form
                $("#query_form").find("#saved-query").attr('disabled', 'disabled');
            } else if ($("#saved-query").val() === 'None') {
                $("#saved-query").val('');
            }
            // removes empty inputs from form
            $("#query_form").find(':input').filter(function() {
                return !($(this).is('input:checkbox:checked') || !$(this).is('input:checkbox') && $(this).val() !== '');
            }).attr('disabled', 'disabled');

            document.forms['query_form'].submit();
        }
    }

    // Perform ticket mass update asynchronously, then
    // reload page with current query and ticket view preferences
    function massUpdate() {
        let refreshFlag = true;
        $.ajax({
            url: "{% url 'helpdesk:mass_update' %}",
            type: 'POST',
            data: new FormData(document.forms['ticket_mass_update']),
            processData: false,
            contentType: false,
            xhrFields: {
                responseType: 'blob',
            },
            // https://stackoverflow.com/a/23797348/20234455
            success: function(blob, status, xhr) {
                if (typeof blob === 'string') {
                    location.reload();
                } else {
                    refreshFlag = false;
                    // todo: if not an export action, dont do this
                    // check for a filename
                    var filename = "";
                    var disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        var matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                    }
                    if (typeof window.navigator.msSaveBlob !== 'undefined') {
                        // IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
                        window.navigator.msSaveBlob(blob, filename);
                    } else {
                        var URL = window.URL || window.webkitURL;
                        var downloadUrl = URL.createObjectURL(blob);

                        if (filename) {
                            // use HTML5 a[download] attribute to specify filename
                            var a = document.createElement("a");
                            // safari doesn't support this yet
                            if (typeof a.download === 'undefined') {
                                window.location.href = downloadUrl;
                            } else {
                                a.href = downloadUrl;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                            }
                        } else {
                            window.location.href = downloadUrl;
                        }
                        setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup
                    }
                }
            },
            complete: function() {
                if (refreshFlag) location.reload();
            }
        });
    }

    function checkCheckboxes () {
        // visual filter updates when checkboxes are toggled on or off
        $(".query-filter-group").each(function (i) {
            let chain = ".collapse > .form-check > .form-check-input:checkbox:checked";
            if ($(this).find(chain).length > 0) {
                $(this).find(".query-counter").text($(this).find(chain).length);
            } else {
                $(this).find(".query-counter").text("");
            }
        });
    }
    function checkInputs () {
        // visual filter updates when query form fields are changed
        let flag;
        $(".query-filter-group").each(function (i) {
            flag = false;
            let on = ".collapse > .input-group > div > .form-control";
            $(this).find(on).each(function () {
                // loops through fields in each filter group to find any with a value
                if ($(this).val()) {
                    flag = true;
                }
            });
            if (flag) {
                $(this).find(".query-on").show()
            } else {
                $(this).find(".query-on").hide();
            }
        });
    }
    checkInputs();
    checkCheckboxes();

    $(document).on("change", ".form-control", function() {
        checkInputs();
    });
    $(document).on("change", ".form-check-input", function() {
        checkCheckboxes();
    });

    // changes icon of sorting button
    $("#id_sortreverse").click(function(e) {
        let desc = false;
        if ($(this).prop('checked')) {
            desc = true;
        }
        $("#sort_asc").toggle(!desc);
        $("#sort_desc").toggle(desc);
    });
</script>

<!--TODO Move this to a separate file, keep django specific code here or use API calls somehow-->
<script>
    function get_url(row) {
        return "{% url 'helpdesk:view' 1234 %}".replace(/1234/, row.id.toString());
    }
    var from_saved_query = {% if from_saved_query %}true{% else %}false{% endif %};

    var selected = [];
    var all_ticket_ids = [];
    var globalTimeout = null;

    $(document).ready(function () {
        // Duplicate thead for column filtering
        $('#ticketTable thead tr').clone(true).addClass('filters').appendTo('#ticketTable thead');
        $('.filters th').slice(1,).each( function (i) {
            i = i+1;
            var title = $('#ticketTable thead th').eq( $(this).index() ).text();
            $(this).html( '<input type="text" style="width:auto" placeholder="'+title+'" data-index="'+i+'" />' );
        } );

                for (const id of document.querySelectorAll(".ticket_multi_select")) {
                    all_ticket_ids.push(id.value)
                }

                $('#dataTable').off('keyup change').on('keyup', 'thead input', function () {
                    if (globalTimeout != null) clearTimeout(globalTimeout);
                    globalTimeout = setTimeout(filterFunction, 400, this);
                });

                get_visible_cols(); // On initialization

                {# Timeline initialization when tab is displayed #}
                // The TL.Timeline constructor takes at least two arguments:
                // the id of the Timeline container (no '#'), and
                // the URL to your JSON data file or Google spreadsheet.
                // the id must refer to an element "above" this code,
                // and the element must have CSS styling to give it width and height
                // optionally, a third argument with configuration options can be passed.
                // See below for more about options.

                let timeline_loaded = false;
                $('#timelinetabcontents-tab').on('shown.bs.tab', function (e) {
                    if (!timeline_loaded) {
                        new TL.Timeline(
                            'timeline-embed',
                            '{% url 'helpdesk:timeline_ticket_list' urlsafe_query %}'
                            );
                        timeline_loaded = true;
                    }
                });


                update_selected_ids = function () {
                    // Add data to post field to be available in mass_update function, and save_query
                    $('input[name="selected_ids"]').each(function () {
                        $(this).val(selected.toString());
                    });

                    // Disables or enables buttons/dropdowns based on tickets selected
                    if ($('input[name="selected_ids"]').val() === '') {
                        $('#id_mass_action').attr('disabled', true);
                        $('#massActionButton').attr('disabled', true);
                        $('#editTagsDropdown').addClass('disabled');
                        $('.select_count').text('');
                    } else {
                        $('#id_mass_action').attr('disabled', false);
                        $('#massActionButton').attr('disabled', false);
                        $('#editTagsDropdown').removeClass('disabled');
                        $('.select_count').text(' (' + selected.length + ' selected)');
                    }
                }

                                        {# Shortcuts to select/unselect multiple tickets #}
                                        $("#select_all_btn").click(function () {
                                            $(".ticket_multi_select").prop('checked', true);
                                            all_ticket_ids.forEach(function(e) {
                                                if (!selected.includes(String(e))) {
                                                    selected.push(String(e));
                                                }
                                            })
                                            update_selected_ids();
                                        });

                                        $("#select_none_btn").click(function () {
                                            $(".ticket_multi_select").prop('checked', false);
                                            selected = [];
                                            update_selected_ids();
                                        });

                                        $("#select_inverse_btn").click(function () {
                                            $(".ticket_multi_select").each(function () {
                                                $(this).prop('checked', !$(this).prop('checked'));
                                            });
                                            unselected = all_ticket_ids.filter(function (e) {
                                                return !selected.includes(String(e));
                                            }).map(e => String(e));
                                            selected = unselected;
                                            update_selected_ids();
                                        });

                                        $(document).on('click', '.ticket_multi_select', function () {
                                            if ($(this).prop('checked')) {
                                                if (!selected.includes($(this).val())) {
                                                    selected.push($(this).val())
                                                }
                                            } else {
                                                var index = selected.indexOf($(this).val());
                                                if (index !== -1) {
                                                    selected.splice(index, 1);
                                                }
                                            };
                                            update_selected_ids();
                                        });
                                    })

    function getTags() {
        // updates the Add/Remove Tags checkboxes
        update_selected_ids();
        var selected = $('input[name="selected_ids"]').val();
        selected = JSON.parse("[" + selected + "]");

        $('.custom-control-input').removeClass('indeterminate');
        $('.custom-control-input').prop('checked', false);
        $('.custom-control-input').prop('indeterminate', false);
        $('.custom-control-input').prop('readOnly', false);
        $.ajax({
            url: "{% url 'helpdesk:get_tags' %}",
            type: 'GET',
            data: {'selected': selected},
            success: function(response) {
                // update checkboxes
                for (var key in response['tags']) {
                    if (response['tags'][key] === 'indeterminate') {
                        $('.custom-control-input#tagCheck' + key).prop('indeterminate', true);
                        $('.custom-control-input#tagCheck' + key).prop('readOnly', true);
                        $('.custom-control-input#tagCheck' + key).addClass('indeterminate');
                    } else if (response['tags'][key] === 'on') {
                        $('.custom-control-input#tagCheck' + key).prop('checked', true);
                    }
                }
            }
        });
    }

    $('.custom-checkbox').on('click', '.indeterminate', function() {
        /* When a checkbox in the Add/Remove Tags dropdown is clicked, this controls whether it's marked on, off, or indeterminate (meaning, don't change)
            readOnly == true: indeterminate
            checked == true: on
            checked == false: off */
        if (this.readOnly) this.checked=this.readOnly=false;
        else if (!this.checked) this.readOnly=this.indeterminate=true;
    });

    function massUpdateTags() {
        // Updates ticket tags based on Add/Remove Tags dropdown

        let selected = $('input[name="selected_ids"]').val();
        selected = JSON.parse("[" + selected + "]");
        let add_tags = [];
        let remove_tags = [];
        $('.custom-control-input').each(function () {
            if (!this.readOnly) {
                if (this.checked) {
                    add_tags.push($(this).val());
                } else {
                    remove_tags.push($(this).val());
                }
            }
        });
        $.ajax({
            url: "{% url 'helpdesk:mass_update_tags' %}",
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                'selected': selected,
                'add_tags': add_tags,
                'remove_tags': remove_tags
            },
            success: function(response) {
                location.reload();
            }
        });
    }

                                    $('.delete_query').click(function() {
                                        var value = $(this).val();
                                        var method = "POST";
                                        var url = "{% url 'helpdesk:delete_query' 1234 %}";
                                        $.ajax({
                                            method: method,
                                            url: url.replace(/1234/, value),
                                            data: { csrfmiddlewaretoken: '{{ csrf_token }}'},
                                            success: function(data, textStatus) {
                                                // Remove option from list
                                                $(".saved_query_selector[value='" + value + "']").remove();
                                                if ( from_saved_query && "{{ saved_query.id }}" === value) {
                                                    window.location.href = "{% url 'helpdesk:list' %}";
                                                }
                                            }
                                        })
                                    });

                                    $(".saved_query_selector").on('click', function (e) {
                                        if (e.target.classList.contains('saved_query_active')) {
                                            window.location.href = "{% url 'helpdesk:list' %}";
                                        } else if (e.target.classList.contains('saved_query_selector')) {
                                            window.location.href = "{% url 'helpdesk:list' %}?saved-query=" + $(e.target).val();
                                        }
                                    });

                                </script>
                                {% endblock %}
                                
                                